<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prototipo - Asistencia con QR</title>
  <style>
    :root{--accent:#0ea5a4;--muted:#666}
    body{font-family:Inter,system-ui,Segoe UI,Arial;margin:0;background:#f7faf9;color:#0f172a}
    .wrap{max-width:1100px;margin:18px auto;padding:12px}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    header h1{font-size:18px;margin:0}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:12px}
    .card{background:white;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    label{display:block;font-size:13px;margin-top:8px}
    input,select,button{width:100%;padding:8px;margin-top:6px;border:1px solid #e6edf0;border-radius:6px;font-size:14px}
    button{cursor:pointer;background:var(--accent);color:white;border:none}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #f1f5f9;font-size:13px}
    .indicator{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:600}
    .red{background:#fee2e2;color:#b91c1c}
    .yellow{background:#fff7ed;color:#92400e}
    .green{background:#ecfdf5;color:#065f46}
    #qrcode-canvas{display:block;margin-top:8px}
    .small{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:8px}
    .left-col{min-width:360px}
    .scanner-wrap{display:flex;flex-direction:column;gap:8px}
    .status-present{color:green;font-weight:600}
    .status-absent{color:#666}
    @media (max-width:880px){.grid{grid-template-columns:1fr;}.left-col{min-width:unset}}
  </style>
  <!-- Librer√≠as QR y Firebase -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Prototipo - Asistencia con QR (Firebase)</h1>
      <div class="small">Lista en tiempo real ¬∑ Escaneo m√≥vil ¬∑ Indicadores por secci√≥n (50% + 1)</div>
    </header>

    <div class="grid">
      <div class="left-col">
        <div class="card">
          <h3>Administraci√≥n</h3>

          <label>Crear secci√≥n (nombre)</label>
          <input id="section-name" placeholder="Secci√≥n A, Grupo 1..." />
          <button id="btn-add-section">Crear secci√≥n</button>

          <hr style="margin:10px 0;border:none;border-top:1px dashed #eef2f7" />

          <label>Crear usuario</label>
          <input id="user-name" placeholder="Nombre completo" /> 
          <label>Asignar a secci√≥n</label>
          <select id="user-section"><option value="">-- selecciona --</option></select>
          <button id="btn-add-user">Crear usuario y generar QR</button>

          <div style="margin-top:10px">
            <strong>√öltimo QR generado:</strong>
            <div id="qrcode-holder"></div>
            <canvas id="qrcode-canvas"></canvas>
            <div id="last-generated" class="small"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Secciones</h3>
          <div id="sections-list" class="small"></div>
        </div>
      </div>

      <div>
        <div class="card scanner-wrap">
          <h3>Esc√°ner (m√≥vil / desktop)</h3>
          <div id="reader" style="width:100%"></div>
          <div class="row">
            <button id="start-scan">Iniciar esc√°ner</button>
            <button id="stop-scan">Detener</button>
            <button id="clear-attendance">Reset asistencia</button>
          </div>
          <div id="scan-log" class="small"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Lista de asistencia (en tiempo real)</h3>
          <div style="margin-bottom:8px">
            <label>Filtrar por secci√≥n</label>
            <select id="filter-section"><option value="">Todas</option></select>
          </div>
          <div style="max-height:420px;overflow:auto">
            <table id="attendance-table">
              <thead><tr><th>Nombre</th><th>Secci√≥n</th><th>Estado</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <footer style="margin-top:12px;font-size:12px;color:var(--muted)">Reemplaza <code>firebaseConfig</code> con tu configuraci√≥n de Firebase. Usa Firestore en modo de pruebas mientras prototipas.</footer>
  </div>

<script>
  // Configuraci√≥n Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCZv-In5JXxpgUnm4yFYtmJNhQFwP3vm40",
    authDomain: "proyecto-asistencia-b2820.firebaseapp.com",
    projectId: "proyecto-asistencia-b2820"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const userSectionSelect = document.getElementById("user-section");
  const filterSectionSelect = document.getElementById("filter-section");

  // Crear secci√≥n
  document.getElementById("btn-add-section").addEventListener("click", async () => {
    const name = document.getElementById("section-name").value.trim();
    if (!name) return;
    await db.collection("secciones").doc(name).set({ totalUsuarios:0, presentes:0 });
    document.getElementById("section-name").value="";
  });

  // Crear usuario y generar QR (bug corregido)
  document.getElementById("btn-add-user").addEventListener("click", async () => {
    const name = document.getElementById("user-name").value.trim();
    const section = userSectionSelect.value;
    if(!name || !section) return alert("Ingrese nombre y secci√≥n");
    const userRef = db.collection("usuarios").doc();
    const userId = userRef.id;
    await userRef.set({ nombre:name, seccion:section, qrCode:userId, asistencia:false });

    // Incremento at√≥mico de totalUsuarios
    const secRef = db.collection("secciones").doc(section);
    await db.runTransaction(async (t)=>{
      const doc = await t.get(secRef);
      if(doc.exists){
        t.update(secRef, { totalUsuarios: (doc.data().totalUsuarios||0)+1 });
      } else {
        t.set(secRef,{ totalUsuarios:1, presentes:0 });
      }
    });

    // Generar QR
    document.getElementById("qrcode-canvas").innerHTML="";
    QRCode.toCanvas(document.getElementById("qrcode-canvas"), userId, (err)=>{});
    document.getElementById("last-generated").textContent = name;
    document.getElementById("user-name").value="";
  });

  // Cargar secciones en selects
  db.collection("secciones").onSnapshot(snap=>{
  userSectionSelect.innerHTML = '<option value="">-- selecciona --</option>';
  filterSectionSelect.innerHTML = '<option value="">Todas</option>';
  let sectionsHtml = '';
  snap.forEach(doc=>{
    const id = doc.id;
    const data = doc.data();

    const total = data.totalUsuarios || 0;
    const presentes = data.presentes || 0;

    // Condici√≥n 50% + 1
    const necesario = Math.floor(total / 2) + 1;
    const cumplido = presentes >= necesario && total > 0;

    // circulito verde si se cumple
    const indicador = cumplido 
      ? `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#22c55e;margin-left:6px"></span>` 
      : "";

    sectionsHtml += `${id} (${presentes}/${total}) ${indicador}<br>`;

    // Selects
    const opt1 = document.createElement("option"); opt1.value=id; opt1.textContent=id;
    userSectionSelect.appendChild(opt1);
    const opt2 = document.createElement("option"); opt2.value=id; opt2.textContent=id;
    filterSectionSelect.appendChild(opt2);
  });
  document.getElementById("sections-list").innerHTML=sectionsHtml;
});


  // Esc√°ner QR
let html5QrCode = null;

const startScanBtn = document.getElementById("start-scan");
const stopScanBtn = document.getElementById("stop-scan");
const scanLog = document.getElementById("scan-log");

startScanBtn.addEventListener("click", async () => {
  if (html5QrCode) return; // ya est√° corriendo

  html5QrCode = new Html5Qrcode("reader");

  try {
    await html5QrCode.start(
      { facingMode: "environment" }, // c√°mara trasera
      { fps: 10, qrbox: { width: 250, height: 250 } },
      async (decodedText) => {
        try {
          const uRef = db.collection("usuarios").doc(decodedText);
          const doc = await uRef.get();

          if (doc.exists && !doc.data().asistencia) {
            await uRef.update({ asistencia: true });

            const sRef = db.collection("secciones").doc(doc.data().seccion);
            await db.runTransaction(async (t) => {
              const sdoc = await t.get(sRef);
              if (sdoc.exists) {
                t.update(sRef, { presentes: (sdoc.data().presentes || 0) + 1 });
              }
            });

            scanLog.textContent = `‚úÖ Asistencia registrada: ${doc.data().nombre}`;
          } else if (doc.exists && doc.data().asistencia) {
            scanLog.textContent = `‚ö†Ô∏è ${doc.data().nombre} ya estaba presente.`;
          } else {
            scanLog.textContent = "‚ùå Usuario no encontrado.";
          }
        } catch (err) {
          console.error(err);
          scanLog.textContent = "‚ùå Error al registrar asistencia.";
        }
      }
    );
    scanLog.textContent = "üì∑ Esc√°ner iniciado, apunta a un QR...";
  } catch (err) {
    console.error("Error al iniciar esc√°ner:", err);
    scanLog.textContent = "‚ùå No se pudo iniciar la c√°mara.";
  }
});

stopScanBtn.addEventListener("click", async () => {
  if (html5QrCode) {
    try {
      await html5QrCode.stop();
      html5QrCode.clear();
      html5QrCode = null;
      scanLog.textContent = "‚èπÔ∏è Esc√°ner detenido.";
    } catch (err) {
      console.error("Error al detener esc√°ner:", err);
    }
  }
});


document.getElementById("stop-scan").addEventListener("click", () => {
  if (html5QrCode) {
    html5QrCode.stop().then(() => {
      html5QrCode.clear();
      html5QrCode = null;
      document.getElementById("scan-log").textContent = "‚èπÔ∏è Esc√°ner detenido.";
    });
  }
});

  // Lista de asistencia
  db.collection("usuarios").onSnapshot(snap=>{
    const tbody = document.querySelector("#attendance-table tbody");
    tbody.innerHTML="";
    snap.forEach(doc=>{
      const u=doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML=`<td>${u.nombre}</td><td>${u.seccion}</td><td class="${u.asistencia?'status-present':'status-absent'}">${u.asistencia?'Presente':'Ausente'}</td>`;
      tbody.appendChild(tr);
    });
  });
</script>
</body>
</html>
