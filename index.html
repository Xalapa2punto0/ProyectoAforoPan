<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lector de QR con Folios</title>
<script src="https://unpkg.com/html5-qrcode" defer></script>
<style>
  body{
    font-family: Arial, sans-serif;
    margin:0;
    padding:20px;
    text-align:center;
    background:#f9f9f9;
  }
  h1{font-size:1.5em;margin-bottom:20px;}
  #qr-reader{width:100%;max-width:400px;margin:auto;}
  #result{margin-top:20px;font-size:1.1em;}
  #lista-usados{
    margin-top:30px;text-align:left;
    max-width:400px;margin-left:auto;margin-right:auto;
  }
  .usado{color:green;font-weight:bold;}

  /* Notificaciones */
  .notification{
    position:fixed;bottom:20px;left:50%;
    transform:translateX(-50%);
    background:#333;color:#fff;
    padding:12px 20px;border-radius:8px;
    font-size:1em;opacity:0;pointer-events:none;
    transition:opacity .4s ease,transform .4s ease;
    z-index:9999;
  }
  .notification.show{
    opacity:1;
    transform:translateX(-50%) translateY(-10px);
  }
  .notification.success{background:#28a745;}
  .notification.error{background:#dc3545;}

  @media (max-width:600px){
    h1{font-size:1.2em;}
    #result{font-size:1em;}
  }
  /* Botones extra */
  .controls{
    display:flex;justify-content:center;
    gap:10px;margin:10px 0;
  }
</style>
</head>
<body>
<h1>Escanear Folios QR</h1>

<div class="controls">
  <button id="btnSwitch">üîÅ Cambiar c√°mara</button>
  <button id="btnTorch">üî¶ Linterna</button>
</div>

<div id="qr-reader"></div>
<div id="result"></div>

<div id="lista-usados">
  <h2>Folios usados:</h2>
  <ul id="usados"></ul>
</div>

<div id="notification" class="notification"></div>

<script>
const foliosUsados = new Set();
const notification = document.getElementById("notification");
const SCAN_DELAY = 2000;
let lastScanTime = 0;
let html5QrcodeScanner;
let currentTrack = null;
let torchOn = false;

function showNotification(msg,type="success"){
  notification.textContent = msg;
  notification.className = `notification ${type} show`;
  setTimeout(()=>notification.classList.remove("show"),3000);
}

function onScanSuccess(decodedText){
  const now = Date.now();
  if(now - lastScanTime < SCAN_DELAY) return;
  lastScanTime = now;

  if(!foliosUsados.has(decodedText)){
    foliosUsados.add(decodedText);
    const li=document.createElement('li');
    li.textContent=decodedText;
    li.classList.add('usado');
    document.getElementById('usados').appendChild(li);
    document.getElementById('result').innerText=`Folio escaneado: ${decodedText}`;
    showNotification(`‚úÖ Nuevo folio: ${decodedText}`,"success");
  }else{
    document.getElementById('result').innerText=`Folio repetido: ${decodedText}`;
    showNotification(`‚ö†Ô∏è Folio repetido: ${decodedText}`,"error");
  }
}

function onScanError(err){/* opcional: console.warn(err); */}

document.addEventListener("DOMContentLoaded", ()=>{
  // --- inicializa el widget oficial ---
  html5QrcodeScanner = new Html5QrcodeScanner("qr-reader",{
    fps:10,
    qrbox: ()=>{ 
      const size=Math.min(window.innerWidth*0.7,400);
      return {width:size,height:size};
    },
    experimentalFeatures:{useBarCodeDetectorIfSupported:true},
    rememberLastUsedCamera:true
  });
  html5QrcodeScanner.render(onScanSuccess,onScanError);

  // Bot√≥n cambiar c√°mara
  document.getElementById("btnSwitch").addEventListener("click", async ()=>{
    try{
      const cams = await Html5Qrcode.getCameras();
      if(cams.length<2){showNotification("No hay otra c√°mara","error");return;}
      // alternar entre c√°maras
      const current = html5QrcodeScanner.getState().cameraId;
      const idx = cams.findIndex(c=>c.id===current);
      const next = cams[(idx+1)%cams.length];
      await html5QrcodeScanner.clear();
      html5QrcodeScanner.render(onScanSuccess,onScanError,next.id);
    }catch(e){console.error(e);showNotification("Error al cambiar c√°mara","error");}
  });

  // Bot√≥n linterna
  document.getElementById("btnTorch").addEventListener("click", async ()=>{
    try{
      const video = document.querySelector("#qr-reader video");
      if(!video || !video.srcObject){showNotification("C√°mara no lista","error");return;}
      const track = video.srcObject.getVideoTracks()[0];
      if(!track.getCapabilities || !track.getCapabilities().torch){
        showNotification("Linterna no soportada","error");return;
      }
      torchOn=!torchOn;
      await track.applyConstraints({advanced:[{torch:torchOn}]});
      showNotification(torchOn?"üî¶ Linterna encendida":"üî¶ Linterna apagada","success");
    }catch(e){console.error(e);showNotification("No se pudo cambiar la linterna","error");}
  });
});
</script>
</body>
</html>
